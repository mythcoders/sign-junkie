image: docker:latest

include:
  - template: Container-Scanning.gitlab-ci.yml
  - template: DAST.gitlab-ci.yml
  - template: Dependency-Scanning.gitlab-ci.yml
  - template: License-Management.gitlab-ci.yml
  - template: SAST.gitlab-ci.yml

services:
  - docker:dind

stages:
  - build
  - test
  - deploy
  - release
  - dast

variables:
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA
  HEROKU_REGISTRY: registry.heroku.com
  PROD_IMAGE: $HEROKU_REGISTRY/sign-junkie-pd/web:latest
  QA_IMAGE: $HEROKU_REGISTRY/sign-junkie-qa/web:latest

build:
  stage: build
  before_script:
    - docker login -u=$CI_REGISTRY_USER -p=$CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo $CI_BUILD_REF_NAME > BRANCH
    - echo $CI_COMMIT_SHA > VERSION
    - echo $(date +%s) > BUILD_TIME
    - docker build -t $CONTAINER_IMAGE .
    - docker push $CONTAINER_IMAGE

test:
  stage: test
  services:
  - docker:dind
  - postgres:latest
  before_script:
    - docker login -u=$CI_REGISTRY_USER -p=$CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $CONTAINER_IMAGE

push_qa:
  stage: deploy
  before_script:
    - docker login -u=$CI_REGISTRY_USER -p=$CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker login -u=_ -p=$HEROKU_API_KEY $HEROKU_REGISTRY
  script:
    - docker pull $CONTAINER_IMAGE
    - docker tag $CONTAINER_IMAGE $QA_IMAGE
    - docker push $QA_IMAGE
  only:
    - branches
  except:
    - master

release_qa:
  image: node:latest
  stage: release
  environment:
    name: qa
    url: https://qa.signjunkieworkshop.com
  before_script:
    - npm install -g heroku
  script:
    - heroku container:release web --app sign-junkie-qa
  only:
    - branches
  except:
    - master

push_pd:
  stage: deploy
  before_script:
    - docker login -u=$CI_REGISTRY_USER -p=$CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker login -u=_ -p=$HEROKU_API_KEY $HEROKU_REGISTRY
  script:
    - docker pull $CONTAINER_IMAGE
    - docker tag $CONTAINER_IMAGE $PROD_IMAGE
    - docker push $PROD_IMAGE
  only:
    - master

release_pd:
  image: node:latest
  stage: release
  environment:
    name: prod
    url: https://signjunkieworkshop.com
  before_script:
    - npm install -g heroku
  script:
    - heroku container:release web --app sign-junkie-pd
  only:
    - master

dast:
  stage: dast
  variables:
    DAST_WEBSITE: https://signjunkieworkshop.com
  only:
    - master
