include:
  - template: Auto-DevOps.gitlab-ci.yml

.auto-deploy:
  image: "registry.gitlab.com/gitlab-org/cluster-integration/auto-deploy-image:v2.12.0"

variables:
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA

build:
  stage: build
  before_script:
    - docker login ghcr.io --username $GITHUB_PACKAGES_USERNAME --password $GITHUB_PACKAGES_PASSWORD
    - docker pull ghcr.io/mythcoders/gaia-ruby2.7:latest
    - echo $CI_BUILD_REF_NAME > BRANCH
    - echo $CI_COMMIT_SHA > VERSION

review:
  stage: review
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: http://$CI_COMMIT_REF_NAME.$KUBE_INGRESS_BASE_DOMAIN

staging:
  stage: staging
  environment:
    name: staging
    url: http://$KUBE_INGRESS_BASE_DOMAIN

production:
  stage: production
  environment:
    name: production
    url: http://$KUBE_INGRESS_BASE_DOMAIN

production_manual:
  stage: production
  environment:
    name: production
    url: http://$KUBE_INGRESS_BASE_DOMAIN
